<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Gesti√≥n de Productos con Selector de Imagen</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  input, button { margin: 6px 0; padding: 6px; width: 300px; }
  ul li { margin-bottom: 10px; list-style: none; }

  /* Modal */
  #modalImagenes {
    display: none; 
    position: fixed; 
    z-index: 999; 
    left: 0; top: 0; 
    width: 100%; height: 100%; 
    overflow: auto; 
    background-color: rgba(0,0,0,0.5);
  }
  #modalContenido {
    background-color: #fff;
    margin: 50px auto; 
    padding: 20px;
    border-radius: 8px;
    max-width: 700px;
    max-height: 80vh;
    overflow-y: auto;
  }
  #modalContenido h3 {
    margin-top: 0;
  }
  #inputFiltro {
    width: 100%;
    padding: 8px;
    margin-bottom: 15px;
    font-size: 16px;
  }
  #contenedor-imagenes img {
    width: 80px; height: 80px; object-fit: cover; margin: 5px;
    border: 2px solid transparent; cursor: pointer; transition: 0.2s;
  }
  #contenedor-imagenes img:hover {
    transform: scale(1.05);
  }
  #contenedor-imagenes img.selected {
    border-color: #4CAF50;
  }
</style>
</head>
<body>

<h2>Agregar Producto</h2>
<input type="text" id="nombre" placeholder="Nombre del producto" /><br />
<input type="number" id="precio" placeholder="Precio" /><br />

<!-- Bot√≥n para abrir modal -->
<button onclick="abrirModal()">Seleccionar Imagen</button>
<p>Imagen seleccionada:</p>
<img id="imagenSeleccionadaPreview" src="" alt="Ninguna imagen seleccionada" width="120" style="border:1px solid #ccc; margin-bottom:10px;">
<input type="hidden" id="imagenSeleccionada" />

<br>
<button onclick="agregarProducto()">Agregar producto</button>
<button onclick="actualizarProducto()">Actualizar producto</button>

<h3>Lista de Productos</h3>
<ul id="lista-productos"></ul>

<!-- Modal -->
<div id="modalImagenes">
  <div id="modalContenido">
    <h3>Seleccionar Imagen</h3>
    <input type="text" id="inputFiltro" placeholder="Filtrar im√°genes por nombre..." oninput="filtrarImagenes()" />
    <div id="contenedor-imagenes">Cargando im√°genes...</div>
    <br>
    <button onclick="cerrarModal()">Cerrar</button>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCwt9dyCf5iF13R2nhar6F2pKIUkT3Om7Q",
    authDomain: "paguinasweb-14611.firebaseapp.com",
    projectId: "paguinasweb-14611",
    storageBucket: "paguinasweb-14611.appspot.com",
    messagingSenderId: "1083919701171",
    appId: "1:1083919701171:web:89d0063a1f9e6e357c4cc6"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let idProductoActual = null;
  let todasImagenes = []; // guardamos aqu√≠ todas las im√°genes para filtrar

  // Abrir modal y cargar im√°genes
  function abrirModal() {
    document.getElementById("modalImagenes").style.display = "block";
    cargarImagenesDisponibles();
  }
  function cerrarModal() {
    document.getElementById("modalImagenes").style.display = "none";
    document.getElementById("inputFiltro").value = "";
  }

  // Cargar im√°genes desde imagenesdb, guardarlas y mostrar
  function cargarImagenesDisponibles() {
    const contenedor = document.getElementById("contenedor-imagenes");
    contenedor.innerHTML = "Cargando im√°genes...";
    db.collection("imagenesdb").orderBy("fecha", "desc").get()
      .then(snapshot => {
        todasImagenes = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          data.id = doc.id;
          todasImagenes.push(data);
        });
        mostrarImagenes(todasImagenes);
      })
      .catch(err => {
        contenedor.innerHTML = "Error al cargar im√°genes: " + err.message;
      });
  }

  // Mostrar im√°genes en el contenedor, con filtro aplicado
  function mostrarImagenes(imagenes) {
    const contenedor = document.getElementById("contenedor-imagenes");
    contenedor.innerHTML = "";
    if (imagenes.length === 0) {
      contenedor.innerHTML = "<p>No se encontraron im√°genes.</p>";
      return;
    }
    imagenes.forEach(data => {
      const img = document.createElement("img");
      img.src = data.url;
      img.alt = data.nombre;
      img.title = data.nombre;
      img.onclick = () => seleccionarImagen(data.url);
      contenedor.appendChild(img);
    });
  }

  // Filtrar im√°genes seg√∫n texto input
  function filtrarImagenes() {
    const filtro = document.getElementById("inputFiltro").value.toLowerCase();
    const filtradas = todasImagenes.filter(img => img.nombre.toLowerCase().includes(filtro));
    mostrarImagenes(filtradas);
  }

  // Seleccionar imagen: asignar valor oculto, mostrar preview y cerrar modal
  function seleccionarImagen(url) {
    document.getElementById("imagenSeleccionada").value = url;
    document.getElementById("imagenSeleccionadaPreview").src = url;
    cerrarModal();
  }

  // Funciones para productos

  function agregarProducto() {
    const nombre = document.getElementById('nombre').value.trim();
    const precio = parseFloat(document.getElementById('precio').value);
    const imageUrl = document.getElementById('imagenSeleccionada').value;

    if (!nombre || isNaN(precio) || !imageUrl) {
      alert("Completa todos los campos y selecciona una imagen.");
      return;
    }

    db.collection("productodb").add({
      nombre,
      precio,
      imageUrl,
      creado: new Date()
    }).then(() => {
      alert("‚úÖ Producto agregado");
      limpiarFormulario();
      cargarProductos();
    }).catch(err => alert("‚ùå Error: " + err.message));
  }

  function cargarProductos() {
    const lista = document.getElementById('lista-productos');
    lista.innerHTML = "Cargando...";

    db.collection("productodb").orderBy("creado", "desc").get()
      .then(snapshot => {
        let html = "";
        snapshot.forEach(doc => {
          const prod = doc.data();
          html += `
            <li>
              <img src="${prod.imageUrl}" width="60" style="vertical-align:middle; margin-right:8px;">
              <strong>${prod.nombre}</strong> - S/ ${prod.precio.toFixed(2)}
              <button onclick="seleccionarProducto('${doc.id}', '${prod.nombre}', ${prod.precio}, '${prod.imageUrl}')">‚úèÔ∏è</button>
              <button onclick="eliminarProducto('${doc.id}')">üóëÔ∏è</button>
            </li>`;
        });
        lista.innerHTML = html || "<p>No hay productos</p>";
      });
  }

  function seleccionarProducto(id, nombre, precio, imageUrl) {
    document.getElementById('nombre').value = nombre;
    document.getElementById('precio').value = precio;
    document.getElementById('imagenSeleccionada').value = imageUrl;
    document.getElementById("imagenSeleccionadaPreview").src = imageUrl;
    idProductoActual = id;
  }

  function actualizarProducto() {
    if (!idProductoActual) return alert("Selecciona un producto para actualizar");

    const nombre = document.getElementById('nombre').value.trim();
    const precio = parseFloat(document.getElementById('precio').value);
    const imageUrl = document.getElementById('imagenSeleccionada').value;

    if (!nombre || isNaN(precio) || !imageUrl) {
      alert("Completa todos los campos y selecciona una imagen.");
      return;
    }

    db.collection("productodb").doc(idProductoActual).update({
      nombre,
      precio,
      imageUrl
    }).then(() => {
      alert("‚úÖ Producto actualizado");
      limpiarFormulario();
      cargarProductos();
    }).catch(err => alert("‚ùå Error al actualizar: " + err.message));
  }

  function eliminarProducto(id) {
    if (!confirm("¬øEliminar este producto?")) return;
    db.collection("productodb").doc(id).delete()
      .then(() => {
        alert("‚úÖ Producto eliminado");
        cargarProductos();
      }).catch(err => alert("‚ùå Error al eliminar: " + err.message));
  }

  function limpiarFormulario() {
    document.getElementById('nombre').value = "";
    document.getElementById('precio').value = "";
    document.getElementById('imagenSeleccionada').value = "";
    document.getElementById("imagenSeleccionadaPreview").src = "";
    idProductoActual = null;
  }

  // Al cargar la p√°gina
  cargarProductos();
</script>
</body>
</html>
