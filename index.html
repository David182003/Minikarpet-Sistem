<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Sistema de Gesti√≥n</title>
  <style>
    * { box-sizing: border-box; }
     body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    input, select, button {
      padding: 8px;
      margin: 5px 0;
      width: 250px;
    }
    .seccion{
      
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 2px;
      text-align: center;
    }

    th {
      background-color: #f4f4f4;
    }

    .total {
      font-weight: bold;
      font-size: 1.2em;
      margin-top: 10px;
    }

    /* MODAL */
    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .close {
      color: red;
      float: right;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover {
      color: darkred;
    }

    input, select, button {
      margin: 5px 0;
      padding: 6px;
      width: 100%;
      max-width: 300px;
    }

    ul li {
      list-style: none;
      margin-bottom: 10px;
    }

    .seccion { display: none; padding: 20px; padding-bottom: 10%; }
    .activo { display: block; }

    .menu-inferior {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #ffffff;
      color: white;
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      box-shadow: 0 -2px 5px rgba(25, 0, 255, 0.2);
      z-index: 1000;
    }

    .menu-inferior a {
      color: rgb(0, 0, 0);
      text-align: center;
      text-decoration: none;
      font-size: 14px;
      flex: 1;
      cursor: pointer;
    }

    .icono { display: block; font-size: 18px; }

    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .modal-content {
      background: #fff;
      padding: 20px;
      width: 90%;
      max-width: 500px;
      border-radius: 8px;
      max-height: 80vh;
      overflow-y: auto;
    }

    #contenedor-imagenes img {
      width: 80px; height: 80px;
      object-fit: cover;
      margin: 5px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: 0.2s;
    }

    #contenedor-imagenes img:hover { transform: scale(1.05); }
    #contenedor-imagenes img.selected { border-color: #4CAF50; }

    #buscadorImagen {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

  
  <div id="inventario" class="seccion activo">

<h2>Sistema</h2>
  <button onclick="abrirModalVenta()">üõí Realizar Venta</button>

  <!-- Modal Venta -->
  <div id="modalVenta" class="modal">
    <div class="modal-content">
      <span class="close" onclick="cerrarModalVenta()">&times;</span>
      <h3>Realizar Venta</h3>
      <select id="productoSelect">
        <option value="">Selecciona un producto</option>
      </select>
      <input type="number" id="cantidadInput" placeholder="Cantidad" min="1">
      <button onclick="agregarAlCarrito()">Agregar</button>

      <table>
        <thead>
          <tr>
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Precio</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody id="carritoTabla"></tbody>
      </table>

      <div class="total">Total: S/ <span id="totalVenta">0.00</span></div>

      <button onclick="cancelarVenta()">Cancelar</button>
      <button onclick="confirmarVenta()">‚úÖ Confirmar Venta</button>
    </div>
  </div>


    <h2>Inventario</h2>

    <input type="text" id="nombre" placeholder="Nombre del producto"><br>

    <select id="categoriaSelect">
      <option value="">Selecciona una categor√≠a</option>
    </select><br>

    <input type="text" id="nuevaCategoria" placeholder="Nueva categor√≠a">
    <button onclick="agregarCategoria()">‚ûï Agregar Categor√≠a</button><br>

    <input type="number" id="stock" placeholder="Stock"><br>
    <input type="number" id="ventas" placeholder="Ventas"><br>

    <button onclick="abrirModal()">Seleccionar Imagen</button>
    <input type="hidden" id="imagenSeleccionada"><br><br>

    <button onclick="agregarProducto()">Agregar producto</button>
    <button onclick="actualizarProducto()">Actualizar producto</button>

    <h3>Lista de Productos</h3>
    <table>
  <thead>
    <tr>
      <th>Imagen</th>
      <th>Nombre</th>
      <th>Categor√≠a</th>
      <th>Stock</th>
      <th>Ventas</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody id="lista-productos">
    <!-- Aqu√≠ se cargar√°n las filas desde JS -->
  </tbody>
</table>
  </div>

  <div id="ganancias" class="seccion ">
    <h2>Ganancias Totales</h2>
    <p><strong>Monto Vendido:</strong> S/ <span id="monto-total">0.00</span></p>
    <p><strong>Ventas Totales:</strong> <span id="ventas-total">0</span></p>
    <h4>Historial de Ventas:</h4>
    <ul id="lista-ventas"></ul>
  </div>

  </div>

  <div id="clientes" class="seccion">
    <h2>Clientes</h2>
    <p>Clientes que f√≠an pr√≥ximamente...</p>
  </div>

  <!-- Modal de selecci√≥n de imagen -->
  <div class="modal" id="modalImagenes">
    <div class="modal-content">
      <h4>Seleccionar Imagen</h4>
      <input type="text" id="buscadorImagen" placeholder="Buscar imagen...">
      <div id="contenedor-imagenes">Cargando im√°genes...</div><br>
      <button onclick="cerrarModal()">Cerrar</button>
    </div>
  </div>

  <!-- Men√∫ inferior -->
  <div class="menu-inferior">
    <a onclick="mostrarSeccion('inventario')"><span class="icono">üì¶</span>Inventario</a>
    <a onclick="mostrarSeccion('ganancias'); mostrarGanancias();"><span class="icono">üí∞</span>Ganancias</a>  
    <a onclick="mostrarSeccion('clientes')"><span class="icono">üë•</span>Clientes</a>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCwt9dyCf5iF13R2nhar6F2pKIUkT3Om7Q",
      authDomain: "paguinasweb-14611.firebaseapp.com",
      projectId: "paguinasweb-14611",
      storageBucket: "paguinasweb-14611.appspot.com",
      messagingSenderId: "1083919701171",
      appId: "1:1083919701171:web:89d0063a1f9e6e357c4cc6"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let idProductoActual = null;

   function mostrarSeccion(id) {
      document.querySelectorAll('.seccion').forEach(s => s.classList.remove('activo'));
      document.getElementById(id).classList.add('activo');
    }
 function mostrarGanancias() {
      const ventasRef = db.collection("ventadb").orderBy("fecha", "desc");
      const montoTotalSpan = document.getElementById("monto-total");
      const ventasTotalSpan = document.getElementById("ventas-total");
      const listaVentas = document.getElementById("lista-ventas");

      listaVentas.innerHTML = "Cargando ventas...";
      let total = 0;
      let contador = 0;

      ventasRef.get().then(snapshot => {
        listaVentas.innerHTML = "";
        snapshot.forEach(doc => {
          const venta = doc.data();
          total += venta.total;
          contador++;

          const li = document.createElement("li");
          li.innerHTML = `
            <strong>Fecha:</strong> ${new Date(venta.fecha.toDate()).toLocaleString()}<br>
            <strong>Total:</strong> S/ ${venta.total.toFixed(2)}<br>
            <strong>Productos:</strong> ${venta.productos.map(p => `${p.nombre} (x${p.cantidad})`).join(', ')}
          `;
          listaVentas.appendChild(li);
        });

        montoTotalSpan.textContent = total.toFixed(2);
        ventasTotalSpan.textContent = contador;
      });
    }
    
    function abrirModal() {
      document.getElementById('modalImagenes').style.display = 'flex';
      cargarImagenes();
    }

    function cerrarModal() {
      document.getElementById('modalImagenes').style.display = 'none';
    }

    function cargarImagenes() {
      const contenedor = document.getElementById('contenedor-imagenes');
      const buscador = document.getElementById('buscadorImagen');
      contenedor.innerHTML = "Cargando im√°genes...";

      db.collection("imagenesdb").orderBy("fecha", "desc").get().then(snapshot => {
        const todas = [];
        snapshot.forEach(doc => todas.push(doc.data()));

        function mostrarFiltradas(filtro) {
          contenedor.innerHTML = "";
          const filtradas = todas.filter(img => img.nombre.toLowerCase().includes(filtro.toLowerCase()));
          if (filtradas.length === 0) {
            contenedor.innerHTML = "<p>No se encontraron im√°genes.</p>";
            return;
          }
          filtradas.forEach(data => {
            const img = document.createElement("img");
            img.src = data.url;
            img.alt = data.nombre;
            img.onclick = () => {
              document.getElementById('imagenSeleccionada').value = data.url;
              cerrarModal();
            };
            contenedor.appendChild(img);
          });
        }

        mostrarFiltradas("");
        buscador.oninput = () => mostrarFiltradas(buscador.value);
      });
    }

   

    function cargarCategorias() {
      const select = document.getElementById('categoriaSelect');
      select.innerHTML = `<option value="">Selecciona una categor√≠a</option>`;

      db.collection("categoriasdb").orderBy("nombre").get()
        .then(snapshot => {
          snapshot.forEach(doc => {
            const cat = doc.data();
            const option = document.createElement("option");
            option.value = cat.nombre;
            option.textContent = cat.nombre;
            select.appendChild(option);
          });
        });
    }

    function agregarCategoria() {
      const nueva = document.getElementById('nuevaCategoria').value.trim();
      if (!nueva) return alert("Ingresa el nombre de la categor√≠a");

      db.collection("categoriasdb").add({
        nombre: nueva,
        creado: new Date()
      }).then(() => {
        alert("‚úÖ Categor√≠a agregada");
        document.getElementById('nuevaCategoria').value = "";
        cargarCategorias();
      });
    }

    function agregarProducto() {
      const nombre = document.getElementById('nombre').value.trim();
      const categoria = document.getElementById('categoriaSelect').value;
      const stock = parseInt(document.getElementById('stock').value);
      const ventas = parseInt(document.getElementById('ventas').value);
      const imageUrl = document.getElementById('imagenSeleccionada').value;

      if (!nombre || !categoria || isNaN(stock) || isNaN(ventas) || !imageUrl) {
        alert("Completa todos los campos y selecciona una imagen.");
        return;
      }

      db.collection("productodb").add({
        nombre, categoria, stock, ventas, imageUrl,
        creado: new Date()
      }).then(() => {
        alert("‚úÖ Producto agregado");
        limpiarFormulario();
        cargarProductos();
      });
    }

    function actualizarProducto() {
      if (!idProductoActual) return alert("Selecciona un producto para actualizar");

      const nombre = document.getElementById('nombre').value.trim();
      const categoria = document.getElementById('categoriaSelect').value;
      const stock = parseInt(document.getElementById('stock').value);
      const ventas = parseInt(document.getElementById('ventas').value);
      const imageUrl = document.getElementById('imagenSeleccionada').value;

      if (!nombre || !categoria || isNaN(stock) || isNaN(ventas) || !imageUrl) {
        alert("Completa todos los campos.");
        return;
      }

      db.collection("productodb").doc(idProductoActual).update({
        nombre, categoria, stock, ventas, imageUrl
      }).then(() => {
        alert("‚úÖ Producto actualizado");
        limpiarFormulario();
        cargarProductos();
      });
    }

    function eliminarProducto(id) {
      if (!confirm("¬øEliminar este producto?")) return;
      db.collection("productodb").doc(id).delete()
        .then(() => {
          alert("‚úÖ Producto eliminado");
          cargarProductos();
        });
    }

    function seleccionarProducto(id, data) {
      document.getElementById('nombre').value = data.nombre;
      document.getElementById('categoriaSelect').value = data.categoria;
      document.getElementById('stock').value = data.stock;
      document.getElementById('ventas').value = data.ventas;
      document.getElementById('imagenSeleccionada').value = data.imageUrl;
      idProductoActual = id;
    }

    function limpiarFormulario() {
      document.getElementById('nombre').value = "";
      document.getElementById('categoriaSelect').value = "";
      document.getElementById('stock').value = "";
      document.getElementById('ventas').value = "";
      document.getElementById('imagenSeleccionada').value = "";
      idProductoActual = null;
    }

   function cargarProductos() {
  const tbody = document.getElementById('lista-productos');
  tbody.innerHTML = "<tr><td colspan='6'>Cargando...</td></tr>";

  db.collection("productodb").orderBy("creado", "desc").get()
    .then(snapshot => {
      if (snapshot.empty) {
        tbody.innerHTML = "<tr><td colspan='6'>No hay productos</td></tr>";
        return;
      }

      let html = "";
      snapshot.forEach(doc => {
        const prod = doc.data();
        html += `
          <tr>
            <td><img src="${prod.imageUrl}" width="50" style="object-fit:cover; border-radius:4px;"></td>
            <td>${prod.nombre}</td>
            <td>${prod.categoria}</td>
            <td>${prod.stock}</td>
            <td>${prod.ventas}</td>
            <td>
              <button onclick='seleccionarProducto("${doc.id}", ${JSON.stringify(prod)})'>‚úèÔ∏è</button>
              <button onclick="eliminarProducto('${doc.id}')">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      });
      tbody.innerHTML = html;
    });
}

    const carrito = [];

    function abrirModalVenta() {
      document.getElementById("modalVenta").style.display = "block";
      cargarProductosEnSelect();
    }

    function cerrarModalVenta() {
      document.getElementById("modalVenta").style.display = "none";
      carrito.length = 0;
      actualizarTabla();
    }

    function cargarProductosEnSelect() {
      const select = document.getElementById("productoSelect");
      select.innerHTML = '<option value="">Selecciona un producto</option>';

      db.collection("productodb").orderBy("nombre").get().then(snapshot => {
        snapshot.forEach(doc => {
          const prod = doc.data();
          const option = document.createElement("option");
          option.value = JSON.stringify({
            id: doc.id,
            nombre: prod.nombre,
            precio: prod.precio
          });
          option.text = `${prod.nombre} - S/ ${prod.precio}`;
          select.appendChild(option);
        });
      });
    }

    function agregarAlCarrito() {
      const productoJSON = document.getElementById("productoSelect").value;
      const cantidad = parseInt(document.getElementById("cantidadInput").value);

      if (!productoJSON || isNaN(cantidad) || cantidad < 1) {
        alert("Selecciona un producto y una cantidad v√°lida.");
        return;
      }

      const producto = JSON.parse(productoJSON);
      const subtotal = producto.precio * cantidad;

      carrito.push({
        id: producto.id,
        nombre: producto.nombre,
        precio: producto.precio,
        cantidad,
        subtotal
      });

      actualizarTabla();
    }

    function actualizarTabla() {
      const tbody = document.getElementById("carritoTabla");
      tbody.innerHTML = "";
      let total = 0;

      carrito.forEach(item => {
        total += item.subtotal;
        tbody.innerHTML += `
          <tr>
            <td>${item.nombre}</td>
            <td>${item.cantidad}</td>
            <td>S/ ${item.precio.toFixed(2)}</td>
            <td>S/ ${item.subtotal.toFixed(2)}</td>
          </tr>
        `;
      });

      document.getElementById("totalVenta").innerText = total.toFixed(2);
    }

    function cancelarVenta() {
      if (confirm("¬øCancelar la venta actual?")) {
        carrito.length = 0;
        actualizarTabla();
        cerrarModalVenta();
        document.getElementById("cantidadInput").value = "";
      }
    }

    function confirmarVenta() {
      if (carrito.length === 0) {
        alert("El carrito est√° vac√≠o.");
        return;
      }

      const venta = {
        productos: carrito,
        total: carrito.reduce((sum, item) => sum + item.subtotal, 0),
        fecha: new Date()
      };

      db.collection("ventadb").add(venta).then(() => {
        alert("‚úÖ Venta registrada correctamente.");
        cancelarVenta();
      }).catch(err => {
        alert("‚ùå Error al registrar la venta: " + err.message);
      });
    }

    // Al cargar la p√°gina
    cargarCategorias();
    cargarProductos();
  </script>
</body>
</html>
